---
title: "dm"
author: "LR"
date: '2022-07-22'
output: html_document
---

R Markdown

Upload packages
```{r, include=FALSE}
library(dplyr)
library(dm)
library(DiagrammeR)
```

Create a dm object
```{r}
dm <- dm_nycflights13()
dm
```

dm is a named list of tables
```{r}
names(dm)
nrow(dm$airports) # [1] 863
dm$flights %>% 
  count(origin)
```

Visualize relationships
```{r}
dm %>% 
  dm_draw()
```

Simple joins
```{r}
dm %>% 
  dm_flatten_to_tbl(flights)
```

Check consistency
```{r}
dm %>% 
  dm_examine_constraints()
```

## Manipulating individual tables

Source: vignettes/tech-dm-keyed.Rmd

Objective: This vignette deals with situations where you want to transform tables of your dm object and then update an existing table or add a new table to the dm object.

Imagine you want to have a column in flights, specifying if a flight left before noon or after.
```{r}
flights_dm <- dm_nycflights13(cycle = TRUE)
flights_dm
```

```{r}
flights_keyed <-
  flights_dm %>% 
  dm_get_tables(keyed=TRUE)
flights_keyed$flights
flights_tbl_mutate <- 
  flights_keyed$flights %>% 
  mutate(am_pm_dep = if_else(dep_time < 1200, "am", "pm"), .after = dep_time)
flights_tbl_mutate
```
To update the original dm with a new flights table we use dm().
```{r}
updated_flights_dm <- 
  dm(
    flights = flights_tbl_mutate,
    !!!flights_keyed[c("airlines", "airports", "planes", "weather")]
  )
updated_flights_dm
```
The schematic view of the data model remains unchanged
```{r}
dm_draw(updated_flights_dm)
```

